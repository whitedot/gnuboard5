name: Check Upstream Updates

on:
  schedule:
    # 매주 월요일 오전 9시 (KST) = 일요일 자정 (UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:  # 수동 실행 가능

jobs:
  check-upstream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/gnuboard/gnuboard5.git || true
          git fetch upstream

      - name: Check for new commits
        id: check
        run: |
          # 분기점 확인
          MERGE_BASE=$(git merge-base HEAD upstream/master)
          echo "merge_base=$MERGE_BASE" >> $GITHUB_OUTPUT

          # 새 커밋 수 확인
          NEW_COMMITS=$(git log --oneline $MERGE_BASE..upstream/master | wc -l)
          echo "new_commits=$NEW_COMMITS" >> $GITHUB_OUTPUT

          # 보안 관련 커밋 확인
          SECURITY_COMMITS=$(git log --oneline --grep="security\|보안\|취약\|XSS\|SQL\|KVE" $MERGE_BASE..upstream/master | wc -l)
          echo "security_commits=$SECURITY_COMMITS" >> $GITHUB_OUTPUT

          # 최신 태그 확인
          LATEST_TAG=$(git describe --tags --abbrev=0 upstream/master 2>/dev/null || echo "unknown")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          echo "=== Upstream Update Check ==="
          echo "Merge base: $MERGE_BASE"
          echo "New commits: $NEW_COMMITS"
          echo "Security commits: $SECURITY_COMMITS"
          echo "Latest upstream tag: $LATEST_TAG"

      - name: Generate commit list
        if: steps.check.outputs.new_commits != '0'
        id: commits
        run: |
          MERGE_BASE=${{ steps.check.outputs.merge_base }}

          # 커밋 목록 생성
          echo "### New Upstream Commits" > commits.md
          echo "" >> commits.md

          # 보안 패치
          echo "#### Security Patches" >> commits.md
          git log --oneline --grep="security\|보안\|취약\|XSS\|SQL\|KVE" $MERGE_BASE..upstream/master >> commits.md || echo "None" >> commits.md
          echo "" >> commits.md

          # 버그 수정
          echo "#### Bug Fixes" >> commits.md
          git log --oneline --grep="fix\|수정\|버그\|오류" $MERGE_BASE..upstream/master >> commits.md || echo "None" >> commits.md
          echo "" >> commits.md

          # 전체 목록
          echo "#### All Commits" >> commits.md
          git log --oneline $MERGE_BASE..upstream/master >> commits.md

          # 변경된 파일 통계
          echo "" >> commits.md
          echo "#### Changed Files" >> commits.md
          echo '```' >> commits.md
          git diff --stat $MERGE_BASE..upstream/master >> commits.md
          echo '```' >> commits.md

          cat commits.md

      - name: Create or update issue
        if: steps.check.outputs.new_commits != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commits = fs.readFileSync('commits.md', 'utf8');

            const title = `Upstream Update Available: ${${{ steps.check.outputs.new_commits }}} new commits (${${{ steps.check.outputs.latest_tag }}})`;

            const body = `## Upstream Repository Update Detected

            | Item | Value |
            |------|-------|
            | New Commits | ${{ steps.check.outputs.new_commits }} |
            | Security Commits | ${{ steps.check.outputs.security_commits }} |
            | Latest Tag | ${{ steps.check.outputs.latest_tag }} |
            | Merge Base | \`${{ steps.check.outputs.merge_base }}\` |

            ${commits}

            ## Action Required

            1. Review the commits above
            2. Prioritize security patches
            3. Follow the Cherry-pick guide in \`UPSTREAM_SYNC.md\`

            ---
            *This issue was automatically generated by the upstream-check workflow.*
            `;

            // 기존 이슈 확인
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            const existingIssue = issues.data.find(i => i.title.startsWith('Upstream Update Available'));

            if (existingIssue) {
              // 기존 이슈 업데이트
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                title: title,
                body: body
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              // 새 이슈 생성
              const result = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['upstream-sync']
              });
              console.log(`Created issue #${result.data.number}`);
            }

      - name: Summary
        run: |
          echo "## Upstream Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| New Commits | ${{ steps.check.outputs.new_commits }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Commits | ${{ steps.check.outputs.security_commits }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest Upstream Tag | ${{ steps.check.outputs.latest_tag }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.new_commits }}" != "0" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "An issue has been created/updated with the commit details." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Repository is up to date with upstream." >> $GITHUB_STEP_SUMMARY
          fi
